---
title: "PRISM breast milk EV-microRNAs and maternal asthma"
output:
  html_document:
    toc: true
    toc_float: true
---


## Required Packages and functions

```{r,warning=FALSE,message=FALSE,eval=FALSE}
library(reshape)
library(ggplot2)
library(gridExtra)
library(knitr)
library(dplyr)
library(kableExtra)
library(tidyverse)
library(stringr)
library(UpSetR)
library(reshape)
library(corrplot)
library(factoextra)
library(EnvStats)
library(MASS)
library(lmtest)
library(sandwich)
# remotes::install_github('jorvlan/raincloudplots')
library(raincloudplots)
library(corrplot)
library(ggthemes)
```

## QC and normalization
```{r,warning=FALSE,message=FALSE,eval=FALSE}
# Raw data
miRNAraw = read.csv('PRISM_Breast Milk_EV_miRNA_raw.csv')

# Cotrol probes
cont = c('ath-miR159a_000338', 'RNU44_001094', 'RNU48_001006', 'U6 rRNA_001973')
# ath-miR159a is used as a control
# RNU33 and RNU 48 are artificual controls
# U6 is a conserved snRNA

# Misannotated probes measuring tRNA
tRNA = c('hsa-miR-1274A_002883', 'hsa-miR-1274B_002884')
length(unique(miRNAraw$Target.Name[!(miRNAraw$Target.Name %in% cont) & !(miRNAraw$Target.Name %in% tRNA)]))
# 752 miRNA probes

# Changing Cq to numeric
miRNAraw$Cq[miRNAraw$Cq == 'Undetermined'] = NA
miRNAraw$Cq = as.numeric(as.character(miRNAraw$Cq))

# Dropping Cq values associated with amplification scores < 1.1
table(miRNAraw$Amp.Score < 1.1)
# FALSE  TRUE 
# 22459 38891 

miRNA = miRNAraw[miRNAraw$Amp.Score >= 1.1,]
# 22459    43

# Dropping Cq values associated with Cq confidence values < 0.8
table(miRNA$Cq.Conf < 0.8)
# FALSE  TRUE 
# 18354  4105 

miRNA = miRNA[miRNA$Cq.Conf >= 0.8,]
# 18354    43

# Dropping Cq values less than the control probe U6 (for this dataset, Cq<10.1)
table(miRNA$Cq < 10.1)
# FALSE  TRUE 
# 18323    31 

miRNA = miRNA[miRNA$Cq >= 10.1,]
# 18323    43

# Dropping control probes
miRNA = miRNA[!(miRNA$Target.Name %in% cont),]
# 15887    43

# Dropping misannotated probes measuring tRNA
miRNA = miRNA[!(miRNA$Target.Name %in% tRNA),]
# 15776    43


# Dropping Cq values > 35
table(miRNA$Cq > 35)
# 15767     9 

miRNA = miRNA[miRNA$Cq <= 35,]
# 15767    43

# Correcting IDs
# Correcting ID as per email with Tessa Bloomquist (12/18/19)
miRNA$Sample.Name[miRNA$Sample.Name == 7070201] = 7074201

# Correcting ID as per email with Mathilda Chiu (2/4/20)
miRNA$Sample.Name[miRNA$Sample.Name == 7006102] = 7006103

# Saving long format QCed data
write.csv(miRNA, '/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/PRISM_Breast Milk_EV_miRNA_QCed_20200218.csv')
miRNA = read.csv('/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/PRISM_Breast Milk_EV_miRNA_QCed_20200218.csv')[,-1]

# Removing special characters in target name (can't be used in column names)
miRNA$Target.Name = as.character(miRNA$Target.Name)
miRNA$Target.Name2 = str_replace_all(miRNA$Target.Name, '[-#]', '.')

# creating a wide format dataset
miRNAwide = data.frame(Sample.Name = miRNA$Sample.Name, Cq = miRNA$Cq, Target.Name2 = miRNA$Target.Name2) %>% spread(Target.Name2, Cq)

# removing columns/probes that are all NA
miRNAwide = miRNAwide[,colSums(is.na(miRNAwide)) < nrow(miRNAwide)]

dim(miRNAwide)[2] - 1
# 550 miRNAs passed QC

# Saving wide format dataset 
write.csv(miRNAwide, 'PRISM breast milk miRNA datasets for Box/PRISM_Breast Milk_EV_miRNA_QCed_wide_20200218.csv')
miRNAwide = read.csv('/Users/annebozack/Documents/Lee/miRNA asthma/PRISM_Breast Milk_EV_miRNA_QCed_wide_20200218.csv')[,-1]

# Number of samples each miRNA detected in and descriptive statistics
df_nDet = data.frame(matrix(nrow = length(colnames(miRNAwide[, 2:ncol(miRNAwide)])), ncol = 7))
df_nDet[,1] = colnames(miRNAwide[, 2:ncol(miRNAwide)])
colnames(df_nDet) = c('miRNA', 'Detected', 'Median', 'IQR', 'Mean', 'SD', '% missing')

for (i in 1:nrow(df_nDet)){
	df_nDet[i,2] = sum(!is.na(miRNAwide[[df_nDet$miRNA[i]]]))
	df_nDet[i,3] = median(miRNAwide[[df_nDet$miRNA[i]]], na.rm=T)
	df_nDet[i,4] = paste0('(', round(quantile(miRNAwide[[df_nDet$miRNA[i]]], na.rm=T), 2)[2], ', ', round(quantile(miRNAwide[[df_nDet$miRNA[i]]], na.rm=T), 2)[4], ')')
	df_nDet[i,5] = mean(miRNAwide[[df_nDet$miRNA[i]]], na.rm=T)
	df_nDet[i,6] = sd(miRNAwide[[df_nDet$miRNA[i]]], na.rm=T)
	df_nDet[i,7] = (sum(is.na(miRNAwide[[df_nDet$miRNA[i]]]))/75)*100
}

# correcting microRNA names
miRBase = read.csv('/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/miRBaseIDs.csv', colClasses = c(rep("character",4)))

miRBase$miRNA = paste0(miRBase$AssayName, '_', miRBase$AssayID)
miRBase$miRNA = str_replace_all(miRBase$miRNA, '[-#]', '.')

df_nDet = merge(df_nDet, miRBase[,c(5,3, 4)], by = 'miRNA')
df_nDet = df_nDet[order(-df_nDet$Detected),]
```

```{r,warning=FALSE,message=FALSE,eval=FALSE}
# Replacing missing Cq values with 35 and normalizing with global mean.
table(is.na(miRNAwide))
# FALSE  TRUE 
 # 15842 25483 

miRNAwide[,c(2:551)][is.na(miRNAwide[,c(2:551)])] = 35

miRNAnorm = data.frame(matrix(ncol = ncol(miRNAwide) - 1, nrow = nrow(miRNAwide)))
colnames(miRNAnorm) = colnames(miRNAwide)[-1]
rownames(miRNAnorm) = miRNAwide[,1]

# check alignment
all(colnames(miRNAnorm) == colnames(miRNAwide[-1]))
# TRUE
all(identical(colnames(miRNAnorm), colnames(miRNAwide[-1])))
# TRUE

for (i in 1:nrow(miRNAnorm)){
	gm = geoMean(as.numeric(miRNAwide[,-1][i,]))
	for (j in 1:ncol(miRNAnorm)){
		miRNAnorm[i,j] = miRNAwide[,-1][i,j] - gm
	}	
}

dim(miRNAnorm)
#  75 550

# adding mean and median of normalized values to miRNAnorm1 (Supplemental spreadsheet 1)
df_nDet$Median_norm_neg = NA
df_nDet$IQR_norm_neg = NA
df_nDet$Mean_norm_neg = NA
df_nDet$SD_norm_neg = NA
for (i in 1:nrow(df_nDet)){
	df_nDet$Median_norm_neg[i] = -(median(miRNAnorm[[df_nDet$miRNA[i]]], na.rm=T))
	df_nDet$IQR_norm_neg[i] = paste0('(', -(round(quantile(miRNAnorm[[df_nDet$miRNA[i]]], na.rm=T), 2)[2]), ', ', -(round(quantile(miRNAnorm[[df_nDet$miRNA[i]]], na.rm=T), 2)[4]), ')')
	df_nDet$Mean_norm_neg[i] = -mean(miRNAnorm[[df_nDet$miRNA[i]]], na.rm=T)
	df_nDet$SD_norm_neg[i] = sd(-(miRNAnorm[[df_nDet$miRNA[i]]]), na.rm=T)
}

write.csv(df_nDet, '/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/suppTab1.csv')

# 80% of samples
75*0.8
# 60

table(df_nDet$Detected >= 60)
# FALSE  TRUE 
  # 420   130 

# Keeping only 130 miRNAs detected in >= 80% of samples
miRNAnorm = data.frame(Sample.Name = rownames(miRNAnorm), miRNAnorm[,colnames(miRNAnorm) %in% df_nDet$miRNA[df_nDet$Detected >= 60]])

dim(miRNAnorm)
#  75 131
```

## Adding pheno data
```{r,warning=FALSE,message=FALSE,eval=FALSE}
pheno = read.csv('/Users/annebozack/Documents/Lee/transfer/PRISM/breastMilkEVmiRNA/maternal_asthma/AB20200922PRISM.csv')
pheno$Sample.Name = NA
pheno$Sample.Name[pheno$iid == 1] = paste0(pheno$hhid[pheno$iid == 1], '01')
pheno$Sample.Name[pheno$iid == 2] = paste0(pheno$hhid[pheno$iid == 2], '02')
pheno$Sample.Name[pheno$iid == 3] = paste0(pheno$hhid[pheno$iid == 3], '03')
pheno$Sample.Name = as.numeric(pheno$Sample.Name)

pheno = pheno[!(is.na(pheno$Sample.Name)),]
pheno = pheno[(pheno$Sample.Name %in% miRNAnorm$Sample.Name),]

pheno$edu2[pheno$educ <= 2] = 1 # high school or GED
pheno$edu2[pheno$educ > 2] = 2 # > high school
pheno$edu2 = as.factor(pheno$edu2)

pheno$momrace2 = as.factor(pheno$momrace2)
pheno$momrace3[pheno$momrace2 == 0 | pheno$momrace2 == 3] = 0 # White/other
pheno$momrace3[pheno$momrace2 == 1] = 1 # Black
pheno$momrace3[pheno$momrace2 == 2] = 2 # Hispanic
pheno$momrace3 = as.factor(pheno$momrace3)

pheno$prepreg_ob[pheno$mbmi_prepreg < 30] = 0
pheno$prepreg_ob[pheno$mbmi_prepreg >= 30] = 1
pheno$prepreg_ob = as.factor(pheno$prepreg_ob)

pheno$chidsex = as.factor(pheno$childsex)

pheno$momAge30[pheno$age_birth < 30] = 0
pheno$momAge30[pheno$age_birth >= 30] = 1
pheno$momAge30 = as.factor(pheno$momAge30)

pheno$smoke = NA
pheno$smoke[pheno$ets_preg == 1 | pheno$smk_preg == 1] = 1 # smoking or ets >= 1 hour/week during pregnancy
pheno$smoke[pheno$ets_preg == 0 & pheno$smk_preg == 0] = 0
pheno$smoke = as.factor(pheno$smoke)

pheno$smk_preg = as.factor(pheno$smk_preg)

# adding 3 level variable for asthma and atopy
pheno$masth3[pheno$masthnow == 1] = 2
pheno$masth3[pheno$masthevr == 1 & is.na(pheno$masth3)] = 1
pheno$masth3[pheno$masthevr == 0] = 0
pheno$matop3[pheno$matopynow == 1] = 2
pheno$matop3[pheno$matopy == 1 & is.na(pheno$matop3)] = 1
pheno$matop3[pheno$matopy == 0] = 0

# transforming to negative Ccq values
miRNAnorm[,c(2:131)] = -miRNAnorm[,c(2:131)]

# combining microRNA and pheno data
miRNAcomb = merge(miRNAnorm, pheno, on='Sample.Name')

# miRNAwithNAs = read.csv('/Users/annebozack/Documents/Lee/transfer/PRISM/breastMilkEVmiRNA/PRISM breast milk miRNA datasets for Box/PRISM_Breast Milk_EV_miRNA_QCed_wide_20200218.csv')[,-1]
# rownames(miRNAwithNAs) = miRNAwithNAs$Sample.Name
# miRNAwithNAs = miRNAwithNAs[,-1]

# miRNAwithNAsmall = miRNAwithNAs[,(colnames(miRNAwithNAs) %in% colnames(miRNAcomb))]

# miRNAcomb$NmiRNA = NA
# for(i in 1:nrow(miRNAcomb)){
	# miRNAcomb$NmiRNA[i] = table(!(is.na(as.numeric(miRNAwithNAsmall[i,]))))[2]
# }

# adding gestational weeks at breast milk collection 
age = read.csv('/Users/annebozack/Documents/Lee/transfer/PRISM/breastMilkEVmiRNA/AB20200117/AB20200117.csv')
colnames(age)[1] = 'Sample.Name'
age = rbind(age, data.frame(Sample.Name = 7006103, hhid = 70061, iid = 3, chage_breastmilk = 0.057377))

miRNAcomb = merge(miRNAcomb, age, on = 'Sample.Name')

# adding a variable for low RNA used in assay
lowRNA = c(7012001, 7022602, 7023801, 7038101, 7049301, 7049201, 7047101, 7029001, 7068301, 7064001, 7018601)
miRNAcomb$lowRNA[miRNAcomb$Sample.Name %in% lowRNA] = 1
miRNAcomb$lowRNA[!(miRNAcomb$Sample.Name %in% lowRNA)] = 0
miRNAcomb$lowRNA = factor(miRNAcomb$lowRNA)

# removing participant with missing maternal astham/atopy data
miRNAcomb = miRNAcomb[miRNAcomb$Sample.Name != 7051401,]

# adding variable for number of microRNAs detected per sample
miRNAwide_nas = read.csv('/Users/annebozack/Documents/Lee/miRNA asthma/PRISM_Breast Milk_EV_miRNA_QCed_wide_20200218.csv')[,-1]
miRNAwide_nas$nDet = NA
for (i in 1:nrow(miRNAwide_nas)){
	miRNAwide_nas$nDet[i] = sum(is.na(miRNAwide_nas[i,c(2:550)]))
}

miRNAcomb = merge(miRNAcomb, miRNAwide_nas[,c(1,552)], by = 'Sample.Name')

# Saving normalized neg Dcq values and pheno data
write.csv(miRNAcomb, '/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/miRNA_normAllAfter35replace_pheno_gt80perc_asthma.csv')
```

## Cleaning pheno data
```{r, eval = F}
# miRNAcomb = read.csv('/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/miRNA_normAllAfter35replace_pheno_gt80perc_asthma.csv')[,-1]

# ensure variables as factors
miRNAcomb$childsex = as.factor(miRNAcomb$childsex)
miRNAcomb$momrace3 = as.factor(miRNAcomb$momrace3)
miRNAcomb$edu2 = as.factor(miRNAcomb$edu2)
miRNAcomb$prepreg_ob = as.factor(miRNAcomb$prepreg_ob)
miRNAcomb$smoke = as.factor(miRNAcomb$smoke)
miRNAcomb$smk_preg = as.factor(miRNAcomb$smk_preg)
miRNAcomb$ets_preg = as.factor(miRNAcomb$ets_preg)
miRNAcomb$momAge30 = as.factor(miRNAcomb$momAge30)
miRNAcomb$masthevr = as.factor(miRNAcomb$masthevr)
miRNAcomb$masthnow = as.factor(miRNAcomb$masthnow)
miRNAcomb$matopy = as.factor(miRNAcomb$matopy)
miRNAcomb$matopynow = as.factor(miRNAcomb$matopynow)
miRNAcomb$masth3 = as.factor(miRNAcomb$masth3)
miRNAcomb$matop3 = as.factor(miRNAcomb$matop3)

# postpartum week of breastmilk collection
miRNAcomb$wk_breastmilk = miRNAcomb$chage_breastmilk * 52

# association between asthma/atopy and number of microRNAs detected
summary(lm(nDet ~ masth3, data = miRNAcomb))
# Coefficients:
#             Estimate Std. Error t value Pr(>|t|)    
# (Intercept)  338.154      8.967  37.711   <2e-16 ***
# masth31       -1.404     33.551  -0.042    0.967    
# masth32        5.568     17.683   0.315    0.754    

summary(lm(nDet ~ matop3, data = miRNAcomb))
# Coefficients:
#            Estimate Std. Error t value Pr(>|t|)    
# (Intercept)  345.861     10.682  32.379   <2e-16 ***
# matop31      -34.461     30.587  -1.127    0.264    
# matop32       -9.194     15.446  -0.595    0.554 

kruskal.test(nDet ~ masth3, data = miRNAcomb)
# Kruskal-Wallis chi-squared = 0.4153, df = 2, p-value = 0.8125

kruskal.test(nDet ~ matop3, data = miRNAcomb)
# Kruskal-Wallis chi-squared = 2.9517, df = 2, p-value = 0.2286

summary(lm(nDet ~ masth3 + childsex + momrace3 + edu2 + wk_breastmilk, data = miRNAcomb))
# Coefficients:
#               Estimate Std. Error t value Pr(>|t|)    
# (Intercept)    295.842     35.102   8.428 4.54e-12 ***
# masth31         11.073     34.003   0.326    0.746    
# masth32          6.525     17.931   0.364    0.717    
# childsex1      -23.908     15.216  -1.571    0.121    
# momrace31       33.755     30.959   1.090    0.280    
# momrace32       42.294     32.153   1.315    0.193    
# edu22           11.872     16.379   0.725    0.471    
# wk_breastmilk    2.034      1.319   1.542    0.128  

summary(lm(nDet ~ matop3 + childsex + momrace3 + edu2 + wk_breastmilk, data = miRNAcomb))
# Coefficients:
#               Estimate Std. Error t value Pr(>|t|)    
# (Intercept)    307.505     36.198   8.495 3.45e-12 ***
# matop31        -24.385     30.967  -0.787    0.434    
# matop32         -7.370     16.120  -0.457    0.649    
# childsex1      -22.610     15.142  -1.493    0.140    
# momrace31       31.036     31.070   0.999    0.321    
# momrace32       37.751     32.462   1.163    0.249    
# edu22            9.100     16.519   0.551    0.584    
# wk_breastmilk    1.991      1.319   1.509    0.136  
```


## PCA
```{r,warning=FALSE,message=FALSE,eval=FALSE}
rownames(miRNAcomb) = miRNAcomb$Sample.Name
pca <- prcomp(miRNAcomb[,c(4:133)], scale = T, center = T)
summary(pca)
# Importance of components:
#                           PC1    PC2     PC3     PC4     PC5     PC6     PC7     PC8     PC9   PC10    PC11   PC12    PC13    PC14    PC15    PC16    PC17    PC18    PC19   PC20    PC21    PC22    PC23   PC24    PC25    PC26    PC27    PC28    PC29    PC30    PC31    PC32    PC33    PC34
# Standard deviation     7.6836 2.8551 2.55583 2.33048 2.17099 2.08624 1.80452 1.61727 1.52643 1.5038 1.47187 1.4468 1.36193 1.29724 1.26991 1.21138 1.19646 1.16124 1.11641 1.0996 1.05427 0.98117 0.97475 0.9333 0.88193 0.84378 0.81035 0.79862 0.76873 0.75678 0.72339 0.69183 0.68344 0.66204
# Proportion of Variance 0.4541 0.0627 0.05025 0.04178 0.03626 0.03348 0.02505 0.02012 0.01792 0.0174 0.01666 0.0161 0.01427 0.01294 0.01241 0.01129 0.01101 0.01037 0.00959 0.0093 0.00855 0.00741 0.00731 0.0067 0.00598 0.00548 0.00505 0.00491 0.00455 0.00441 0.00403 0.00368 0.00359 0.00337
# Cumulative Proportion  0.4541 0.5168 0.56709 0.60887 0.64513 0.67861 0.70365 0.72377 0.74170 0.7591 0.77576 0.7919 0.80613 0.81907 0.83148 0.84276 0.85378 0.86415 0.87374 0.8830 0.89159 0.89899 0.90630 0.9130 0.91898 0.92446 0.92951 0.93442 0.93896 0.94337 0.94739 0.95108 0.95467 0.95804
#                           PC35    PC36    PC37    PC38    PC39    PC40    PC41    PC42    PC43    PC44    PC45    PC46    PC47    PC48    PC49    PC50    PC51    PC52    PC53    PC54    PC55    PC56    PC57    PC58    PC59    PC60   PC61    PC62    PC63    PC64    PC65    PC66   PC67
# Standard deviation     0.64364 0.63630 0.61753 0.56787 0.54475 0.53150 0.51857 0.51328 0.48450 0.47907 0.46337 0.43340 0.42001 0.41256 0.40644 0.38023 0.35330 0.35156 0.33550 0.32470 0.30385 0.30023 0.28437 0.27590 0.26124 0.23409 0.2289 0.21317 0.20059 0.19558 0.18310 0.16345 0.1600
# Proportion of Variance 0.00319 0.00311 0.00293 0.00248 0.00228 0.00217 0.00207 0.00203 0.00181 0.00177 0.00165 0.00144 0.00136 0.00131 0.00127 0.00111 0.00096 0.00095 0.00087 0.00081 0.00071 0.00069 0.00062 0.00059 0.00052 0.00042 0.0004 0.00035 0.00031 0.00029 0.00026 0.00021 0.0002
# Cumulative Proportion  0.96123 0.96434 0.96728 0.96976 0.97204 0.97421 0.97628 0.97831 0.98011 0.98188 0.98353 0.98497 0.98633 0.98764 0.98891 0.99002 0.99098 0.99193 0.99280 0.99361 0.99432 0.99502 0.99564 0.99622 0.99675 0.99717 0.9976 0.99792 0.99823 0.99853 0.99878 0.99899 0.9992
#                           PC68    PC69    PC70    PC71    PC72    PC73    PC74      PC75
# Standard deviation     0.14918 0.14687 0.13760 0.12314 0.10700 0.09592 0.08539 3.412e-15
# Proportion of Variance 0.00017 0.00017 0.00015 0.00012 0.00009 0.00007 0.00006 0.000e+00
# Cumulative Proportion  0.99936 0.99952 0.99967 0.99979 0.99987 0.99994 1.00000 1.000e+00

miRNApca = data.frame(Sample.Name = miRNAcomb$Sample.Name, childsex = miRNAcomb$childsex, momrace3 = miRNAcomb$momrace3, edu2 = miRNAcomb$edu2, chage_breastmilk = miRNAcomb$chage_breastmilk, masth3 = miRNAcomb$masth3, matop3 = miRNAcomb$matop3)
miRNApca = cbind(miRNApca, pca$x)

df_pcaAssoc = data.frame(vars = c('childsex', 'momrace3', 'edu2', 'chage_breastmilk', 'masth3', 'matop3'), PC1 = NA, PC2 = NA, PC3 = NA, PC4 = NA, PC5 = NA, PC6 = NA, PC7 = NA, PC8 = NA, PC9 = NA, PC10 = NA, PC11 = NA, PC12 = NA, PC13 = NA)

# Associations with child sex
for (i in c(1:13)){
	df_pcaAssoc[1,i+1] = wilcox.test(formula(paste(colnames(df_pcaAssoc)[i+1], ' ~ childsex')), data = miRNApca)$p.value
}

# Associations with mom race
for (i in c(1:13)){
	df_pcaAssoc[2,i+1] = kruskal.test(formula(paste(colnames(df_pcaAssoc)[i+1], ' ~ momrace3')), data = miRNApca)$p.value
}

# Associations with mom education
for (i in c(1:13)){
	df_pcaAssoc[3,i+1] = wilcox.test(formula(paste(colnames(df_pcaAssoc)[i+1], ' ~ edu2')), data = miRNApca)$p.value
}

# Associations with child age of breast milk collection
for (i in c(1:13)){
	df_pcaAssoc[4,i+1] = cor.test(formula(paste('~ ', colnames(df_pcaAssoc)[i+1], ' + chage_breastmilk')), data = miRNApca, method = 'spearman', exact = F)$p.value
}

# Associations with mom asthma
for (i in c(1:13)){
	df_pcaAssoc[5,i+1] = kruskal.test(formula(paste(colnames(df_pcaAssoc)[i+1], ' ~ masth3')), data = miRNApca)$p.value
}

# Associations with mom atopy
for (i in c(1:13)){
	df_pcaAssoc[6,i+1] = kruskal.test(formula(paste(colnames(df_pcaAssoc)[i+1], ' ~ matop3')), data = miRNApca)$p.value
}

# plotting PCA associations
df_pcaPlot = data.frame(indVar = rep(df_pcaAssoc$vars, times = 13), PC = rep(colnames(df_pcaAssoc)[c(2:14)], each = 6), fill = c(df_pcaAssoc$PC1, df_pcaAssoc$PC2, df_pcaAssoc$PC3, 
	df_pcaAssoc$PC4, df_pcaAssoc$PC5, df_pcaAssoc$PC6, df_pcaAssoc$PC7, df_pcaAssoc$PC8, df_pcaAssoc$PC9, df_pcaAssoc$PC10, df_pcaAssoc$PC11, df_pcaAssoc$PC12, df_pcaAssoc$PC13))
df_pcaPlot$indVar = factor(df_pcaPlot$indVar, levels = rev(c('childsex', 'momrace3', 'edu2', 'chage_breastmilk', 'masth3', 'matop3')))
df_pcaPlot$indVar
df_pcaPlot$PC = factor(df_pcaPlot$PC, levels = c('PC1', 'PC2', 'PC3', 'PC4', 'PC5', 'PC6', 'PC7', 'PC8', 'PC9', 'PC10', 'PC11', 'PC12', 'PC13'))

df_pcaPlot$p_point[df_pcaPlot$fill < 0.1] = "*"
df_pcaPlot$p_point[df_pcaPlot$fill < 0.05] = "**"
# df_pcaPlot$p_point = as.factor(df_pcaPlot$p_point)

p = ggplot(df_pcaPlot, aes(PC, indVar)) + geom_tile(aes(fill = fill), colour = "white", size = 3) + theme_minimal() + scale_fill_gradient(low = "#003262", high = "white", name = 'P-value') + labs(y = '', x = 'microRNA PC') +
  scale_y_discrete(labels = c('Maternal atopy', 'Maternal asthma', 'Week of breast milk collection', 'Maternal education', 'Maternal race', 'Infant sex')) + 
  geom_text(aes(label = p_point), color = 'white', size = 3)

p
# quartz.save(file = '/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/pcaplot.pdf', type = 'pdf', dpi = 300)
# quartz.save(file = '/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/pcaplot.png', type = 'png', dpi = 300)
```

```{r, echo = F, out.width = '100%', echo = F}
knitr::include_graphics("/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/pcaplot.png")
```

## Functions 
```{r, eval = F}
# Function for unadjusted analyses 
dfRlmUnadj = function(dfMIRNA, var, NmiRNAs){
	dfMod = data.frame(matrix(ncol = 11, nrow = NmiRNAs))
	colnames(dfMod) = c('miRNA', 'B_preg', 'CI_L_preg', 'CI_U_preg', 'p_preg', 'p_FDR_preg', 'B_inact', 'CI_L_inact', 'CI_U_inact', 'p_inact', 'p_FDR_inact')
	dfMod$miRNA = colnames(dfMIRNA[c(1:NmiRNAs)])
	for (i in 1:NmiRNAs){
		set.seed(1234)
		test = coeftest(rlm.fit, vcovHC(rlm.fit, type="HC0"))
		dfMod[i,2] = test[3,1]
		dfMod[i,3] = confint(test)[3,1]
		dfMod[i,4] = confint(test)[3,2]
		dfMod[i,5] = test[3,4]
		dfMod[i,7] = test[2,1]
		dfMod[i,8] = confint(test)[2,1]
		dfMod[i,9] = confint(test)[2,2]
		dfMod[i,10] = test[2,4]
	}
	dfMod$p_FDR_preg = p.adjust(dfMod$p_preg, method = 'fdr')
	dfMod$p_FDR_inact = p.adjust(dfMod$p_inact, method = 'fdr')
	return(dfMod)
}

# Function for analyses adjusted for sex, race, education, and week of breast milk collection
dfRlmAdjChage = function(dfMIRNA, var, NmiRNAs){
	dfMod = data.frame(matrix(ncol = 11, nrow = NmiRNAs))
	colnames(dfMod) = c('miRNA', 'B_preg', 'CI_L_preg', 'CI_U_preg', 'p_preg', 'p_FDR_preg', 'B_inact', 'CI_L_inact', 'CI_U_inact', 'p_inact', 'p_FDR_inact')
	dfMod$miRNA = colnames(dfMIRNA[c(1:NmiRNAs)])
	for (i in 1:NmiRNAs){
		set.seed(1234)
		rlm.fit = rlm(dfMIRNA[,i] ~ dfMIRNA[[var]] + dfMIRNA[['childsex']] + dfMIRNA[['momrace3']] + dfMIRNA[['edu2']] + dfMIRNA[['wk_breastmilk']], method = 'M', maxit = 60)
		test = coeftest(rlm.fit, vcovHC(rlm.fit, type="HC0"))
		dfMod[i,2] = test[3,1]
		dfMod[i,3] = confint(test)[3,1]
		dfMod[i,4] = confint(test)[3,2]
		dfMod[i,5] = test[3,4]
		dfMod[i,7] = test[2,1]
		dfMod[i,8] = confint(test)[2,1]
		dfMod[i,9] = confint(test)[2,2]
		dfMod[i,10] = test[2,4]
	}
	dfMod$p_FDR_preg = p.adjust(dfMod$p_preg, method = 'fdr')
	dfMod$p_FDR_inact = p.adjust(dfMod$p_inact, method = 'fdr')
	return(dfMod)
}

# Lambda 
lambda <- function(p) median(qchisq(p, df=1, lower.tail=FALSE), na.rm=TRUE) / qchisq(0.5, df=1)

# QQ plot
gg_qqplot = function(pvector) {
	l = round(lambda(pvector), 3)
	o = -log10(sort(pvector, decreasing = FALSE))
	e = -log10(ppoints(length(pvector)))
	df = data.frame(o = o, e = e)
	ggplot(df, aes(e, o)) + geom_point(alpha = 0.5, size = 1) + geom_abline(intercept = 0, slope = 1, color = '#AB3428') + labs(y = expression(Observed ~ ~-log[10](italic(p))), x = expression(Expected ~ ~-log[10](italic(p)))) + theme_classic() + annotate("text", x = 0.5, y = 2.5, label = paste0('lambda = ', l))
}
```

## Matheral asthma
### Unadjusted 
```{r, eval = F}
asthUnadj = dfRlmUnadj(miRNAcomb[,-c(1:3)], 'masth3', 130)

# Active during pregnancy vs. never
table(asthUnadj$p_preg <0.05 & abs(asthUnadj$B_preg) > 0.2)
# FALSE  TRUE 
  # 112    18 
  
table(asthUnadj$p_FDR_preg <0.2)
# FALSE  TRUE 
  # 124    6

table(asthUnadj$p_FDR_preg <0.1)
# FALSE 
# 130

table(asthUnadj$p_FDR_preg <0.05)
# FALSE 
# 130

# Inactive vs. never
table(asthUnadj$p_inact <0.05 & abs(asthUnadj$B_inact) > 0.2)
# FALSE  TRUE 
  # 93    37
  
table(asthUnadj$p_FDR_inact <0.2)
# FALSE  TRUE 
#   90    40  

table(asthUnadj$p_FDR_inact <0.1)
# FALSE  TRUE 
#   95    35

table(asthUnadj$p_FDR_inact <0.05)
# FALSE  TRUE 
#  102    28

# correcting microRNA names
miRBase = read.csv('/Users/annebozack/Documents/Lee/transfer/PRISM/breastMilkEVmiRNA/lab methods/miRBaseIDs.csv', colClasses = c(rep("character",4)))

miRBase$miRNA = paste0(miRBase$AssayName, '_', miRBase$AssayID)
miRBase$miRNA = str_replace_all(miRBase$miRNA, '[-#]', '.')

asthUnadj = merge(asthUnadj, miRBase[,c(5,3, 4)], by = 'miRNA')

# saving results
write.csv(asthUnadj, file = '/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/asthmaUnadj.csv')
```


### Adjusted for sex, race, education, and week of breast milk collection
```{r, eval = F}
asthAdj = dfRlmAdjChage(miRNAcomb[,-c(1:3)], 'masth3', 130)

# Active during pregnancy vs. never
table(asthAdj$p_preg < 0.05 & abs(asthAdj$B_preg) > 0.2)
# FALSE  TRUE 
  # 121     9 

table(asthAdj$p_FDR_preg < 0.2)
# FALSE 
  # 130 

table(asthAdj$p_FDR_preg < 0.1)
# FALSE 
# 130 
 
table(asthAdj$p_FDR_preg < 0.05)
# FALSE 
# 130 

# Inactive vs. never
table(asthAdj$p_inact < 0.05 & abs(asthAdj$B_inact) > 0.2)
# FALSE  TRUE 
  # 99    31 

table(asthAdj$p_FDR_inact < 0.2)
# FALSE  TRUE 
  # 101    29 
  
table(asthAdj$p_FDR_inact < 0.1)
# FALSE  TRUE 
  # 111    19
 
table(asthAdj$p_FDR_inact < 0.05)
# FALSE  TRUE 
  # 120    10 

# correcting microRNA names
asthAdj = merge(asthAdj, miRBase[,c(5,3, 4)], by = 'miRNA')

sigAsthAdj_preg = asthAdj[asthAdj$p_preg <0.05, ]
sigAsthAdj_preg = sigAsthAdj_preg[order(sigAsthAdj_preg$p_preg),]
sigAsthAdj_inact = asthAdj[asthAdj$p_inact <0.05, ]
sigAsthAdj_inact = sigAsthAdj_inact[order(sigAsthAdj_inact$p_inact),]

asthAdj$logp_preg = -log(asthAdj$p_preg, 10)
asthAdj$sig_preg[asthAdj$p_preg < 0.05] = 1
asthAdj$sig_preg[!(asthAdj$p_preg < 0.05)] = 0.4
asthAdj$logp_inact = -log(asthAdj$p_inact, 10)
asthAdj$sig_inact[asthAdj$p_inact < 0.05] = 1
asthAdj$sig_inact[!(asthAdj$p_inact < 0.05)] = 0.5

# saving results
write.csv(asthAdj, file = '/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/asthmaAdj.csv')
```

#### Active during pregnancy
```{r, echo = F}
sigAsthAdj_preg %>% kable() %>% kable_styling(font_size = 12) 
```

```{r, eval = F}
# Raincloud plots
miRNA = NULL
dCq = NULL
masth3 = NULL
for(i in 1:nrow(sigAsthAdj_preg)){
	miRNA = c(miRNA, rep(sigAsthAdj_preg$miRNA[i], times = nrow(miRNAcomb)))
	dCq = c(dCq, miRNAcomb[[sigAsthAdj_preg$miRNA[i]]])
	masth3 = c(masth3, miRNAcomb$masth3)
}
dfBox = data.frame(miRNA, dCq, masth3)
dfBox_preg = dfBox[dfBox$masth3 != 2,]
dfBox_preg$masth3 = as.factor(as.character(dfBox_preg$masth3))

colnames(dfBox_preg) = c('miRNA', 'y_axis', 'x_axis')

for (i in c(1,2,3,4,5,6,7,9)){
	df_1x1 <- data_1x1(array_1 = dfBox_preg$y_axis[dfBox_preg$x_axis == 1 & dfBox_preg$miRNA == sigAsthAdj_preg$miRNA[i]], 
	  array_2 = dfBox_preg$y_axis[dfBox_preg$x_axis == 3 & dfBox_preg$miRNA == sigAsthAdj_preg$miRNA[i]], jit_distance = .05, jit_seed = 321)
	df_1x1$jit = df_1x1$jit - 0.15
	assign(paste0("asthPlot", i), raincloud_1x1(data = df_1x1,  
      colors = (c('#F78104','#003262')),  
      fills = (c('#F78104','#003262')),  
      size = 0.5,  
      alpha = .6,  
      ort = 'v') + scale_x_continuous(breaks=c(1,2), labels=c("Never", "Active"), limits=c(0.5, 3)) +
  xlab("") + 
  ylab(paste0(sigAsthAdj_preg$miRBaseID[i], "  -ΔCq")) +
  theme_classic())
}

for (i in 8){
	df_1x1 <- data_1x1(array_1 = dfBox_preg$y_axis[dfBox_preg$x_axis == 1 & dfBox_preg$miRNA == sigAsthAdj_preg$miRNA[i]], 
	  array_2 = dfBox_preg$y_axis[dfBox_preg$x_axis == 3 & dfBox_preg$miRNA == sigAsthAdj_preg$miRNA[i]], jit_distance = .05, jit_seed = 321)
	df_1x1$jit = df_1x1$jit - 0.15
	assign(paste0("asthPlot", i), raincloud_1x1(data = df_1x1,  
      colors = (c('#F78104','#003262')),  
      fills = (c('#F78104','#003262')),  
      size = 0.5,  
      alpha = .6,  
      ort = 'v') + scale_x_continuous(breaks=c(1,2), labels=c("Never", "Active"), limits=c(0.5, 3)) +
  xlab("Maternal asthma status") + 
  ylab(paste0(sigAsthAdj_preg$miRBaseID[i], "  -ΔCq")) +
  theme_classic())
}

grid.arrange(asthPlot1, asthPlot2, asthPlot3, asthPlot4, asthPlot5, asthPlot6, asthPlot7, asthPlot8, asthPlot9, nrow = 3) 

# quartz.save(file = '/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/rainPlotAsthmaPreg.pdf', type = 'pdf', dpi = 300)
# 
```


```{r, echo = F, out.width = '100%', echo = F}
knitr::include_graphics("/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/rainPlotAsthmaPreg.png")
```

```{r, warning=FALSE,message=FALSE, eval = F}
# volcano plot
asthVol = ggplot(asthAdj, aes(x = B_preg, y = logp_preg)) + geom_point(size = 1.3, alpha = asthAdj$sig_preg, shape = 16) + geom_hline(yintercept = 0) + 
  geom_vline(xintercept = 0, size = 0.5) + geom_hline(yintercept=-log(0.05, 10), colour = '#b30000', linetype='dashed', size = 0.25) + 
  geom_vline(xintercept=-0.2, colour = '#b30000', linetype='dashed', size = 0.25) + geom_vline(xintercept=0.2, colour = '#b30000', linetype='dashed', size = 0.25) + 
  ylab(expression('-log'['10']~'('~italic('p')~')')) + xlab(expression(~italic("B")['Maternal asthma active during pregnancy vs. never'])) + annotate('text', x = 1.5, y = -log(0.045, 10), label = '~italic(p)== 0.05', parse = T, size=3.5) + 
  scale_colour_manual(values = c('black', '#003262')) + theme_minimal() + theme(text = element_text(size=10)) + theme(legend.position = "none") 

asthVol 
# quartz.save(file = '/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/volplotAsthmaPreg.pdf', type = 'pdf', dpi = 300)
# quartz.save(file = '/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/volplotAsthmaPreg.png', type = 'png', dpi = 300)
```

```{r, echo = F, out.width = '50%', echo = F}
knitr::include_graphics("/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/volplotAsthmaPreg.png")
```

```{r, warning=FALSE,message=FALSE, eval = F}
# correlation among significant micorRNAs
miRNAasthSig = miRNAcomb[,c(sigAsthAdj_preg$miRNA)]
miRBaseSig = miRBase[miRBase$miRNA %in% colnames(miRNAasthSig),]
rownames(miRBaseSig) = miRBaseSig$miRNA
miRBaseSig = miRBaseSig[colnames(miRNAasthSig),]

colnames(miRNAasthSig) = miRBaseSig$miRBaseID

cor = corr.test(as.matrix(miRNAasthSig), method = 'spearman')
ord <- corrMatOrder(cor$r, order = 'hclust')
corOrd = cor$r[ord, ord]
corOrd_p = cor$p[ord, ord]
corOrd[corOrd_p > 0.05] = 0

colCor = colorRampPalette((c('#003262', '#3b7ea1', '#ffffff', '#fdb515', '#D9661F')))

corrplot(corOrd, tl.cex = 1, tl.col = 'black', shade.lwd = 0, method = 'color', type = 'lower', diag = F, col = colCor(50))

# quartz.save(file = '/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/asthSigCorPlot.pdf', type = 'pdf', dpi = 300)
# quartz.save(file = '/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/asthSigCorPlot.png', type = 'png', dpi = 300)
```

```{r, echo = F, out.width = '50%', echo = F}
knitr::include_graphics("/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/asthSigCorPlot.png")
```

```{r, warning=FALSE,message=FALSE, eval = F}
# PC 12 loadings
pca$rotation[sigAsthAdj_preg$miRNA,12]                                                                                                                                                                                                                                                          
#   hsa.miR.191_002299   hsa.miR.200a_000502 hsa.miR.324.5p_000539   hsa.miR.29a._002447    hsa.miR.331_000545 hsa.miR.30a.3p_000416   hsa.miR.1290_002863   hsa.miR.106b_000442   hsa.miR.148b_000471 
#          0.029751596          -0.013453514          -0.017758589           0.036678770           0.003877220          -0.017390002          -0.304990476           0.004207857           0.039415856
```

```{r, warning=FALSE,message=FALSE, eval = F}
# kegg plot
kegg = read.csv('/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/diana_asthma_microRNAs_pathwayUnion.csv')
kegg = kegg[order(kegg$X.genes),]
kegg$neglogp = -log(kegg$p.value, 10)
kegg$neglogp[kegg$neglogp == Inf] = 10
kegg$KEGG.pathway[kegg$KEGG.pathway == 'ECM-receptor interaction'] = 'ECM-receptor interaction*'
kegg$KEGG.pathway[kegg$KEGG.pathway == 'Prion diseases'] = 'Prion diseases*'
kegg = kegg[order(kegg$X.genes),]
kegg$KEGG.pathway = factor(kegg$KEGG.pathway, levels = c(kegg$KEGG.pathway))

keggplot = ggplot(kegg, aes(y = KEGG.pathway, x = X.genes)) + geom_segment(x = 0, y = kegg$KEGG.pathway, xend = kegg$X.genes, yend = kegg$KEGG.pathway) + geom_point(aes(fill=p.value), colour="black",pch=21, size=4) + theme_minimal() + 
  labs(x = 'Number of genes', y = 'KEGG pathway') + scale_fill_continuous(name = expression(~italic('FDR'))) + theme(legend.position = 'bottom') + theme(plot.margin = margin(t = 5, r = -10, b = 5, l = 5, unit = "pt")) + scale_x_continuous(lim = c(0,90))


keggmiRNAs = read.csv('/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/diana_asthma_microRNAs_pathwayUnion_microRNAs.csv')
keggmiRNAs = data.frame(pathway = keggmiRNAs$KEGG.pathway, miRNA = rep(colnames(keggmiRNAs)[-1], each = nrow(keggmiRNAs)), indvar = c(keggmiRNAs[,2], keggmiRNAs[,3], keggmiRNAs[,4], keggmiRNAs[,5], keggmiRNAs[,6], keggmiRNAs[,7], keggmiRNAs[,8], keggmiRNAs[,9], keggmiRNAs[,10]))
keggmiRNAs$pathway[keggmiRNAs$pathway == 'ECM-receptor interaction'] = 'ECM-receptor interaction*'
keggmiRNAs$pathway[keggmiRNAs$pathway == 'Prion diseases'] = 'Prion diseases*'
keggmiRNAs$pathway = factor(keggmiRNAs$pathway, levels = c(kegg$KEGG.pathway))
keggmiRNAs$indvar[keggmiRNAs$indvar == 1] = "#003262"
keggmiRNAs$miRNA = factor(keggmiRNAs$miRNA, levels = c('miR.30a.3p', 'miR.106b.5p', 'miR.148b.3p', 'miR.191.5p', 'miR.200a.3p', 'miR.29a.5p', 'miR.331.3p', 'miR.324.5p', 'miR.1290'))

# keggmiRNAplot = ggplot(keggmiRNAs, aes(miRNA, pathway)) + geom_tile(aes(fill = factor(indvar)), colour = "white", size = 3) + theme_minimal() + scale_fill_manual(values = c('white', '#003262')) + theme(legend.position = "none") + 
#  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + labs(x = '', y = '') + theme(axis.text.y=element_blank()) + theme(plot.margin = margin(t = 5, r = 5, b = 17, l = 5, unit = "pt"))

keggmiRNAplot2 = ggplot(keggmiRNAs, aes(miRNA, pathway)) + geom_point(color = keggmiRNAs$indvar, size = 5, shape = 15) + theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + labs(x = '', y = '') + theme(axis.text.y=element_blank()) + theme(plot.margin = margin(t = 5.1, r = 5, b = 14.9, l = 0, unit = "pt")) + 
  scale_x_discrete(labels = c('miR-30a-3p','miR-106b-5p','miR-148b-3p', 'miR-191-5p', 'miR-200a-3p', 'miR-29a-5p', 'miR-331-3p', 'miR-324-5p', 'miR-1290'))

grid.arrange(keggplot, keggmiRNAplot2, ncol = 2, widths = c(2,1))

# quartz.save(file = '/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/asthKeggPlot.pdf', type = 'pdf', dpi = 300)
# quartz.save(file = '/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/asthKeggPlot.png', type = 'png', dpi = 300)
```

```{r, echo = F, out.width = '100%', echo = F}
knitr::include_graphics("/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/asthKeggPlot.png")
```


#### Inactive
```{r, echo = F}
sigAsthAdj_inact %>% kable() %>% kable_styling(font_size = 12) 
```

```{r, warning=FALSE,message=FALSE, eval = F}
ggplot(asthAdj, aes(x = B_inact, y = logp_inact)) + geom_point(size = 1.3, alpha = asthAdj$sig_inact, shape = 16) + geom_hline(yintercept = 0) + 
  geom_vline(xintercept = 0, size = 0.5) + geom_hline(yintercept=-log(0.05, 10), colour = '#b30000', linetype='dashed', size = 0.25) + 
  geom_vline(xintercept=-0.2, colour = '#b30000', linetype='dashed', size = 0.25) + geom_vline(xintercept=0.2, colour = '#b30000', linetype='dashed', size = 0.25) + 
  ylab(expression('-log'['10']~'('~italic('p')~')')) + xlab(expression(~italic("B"))) + annotate('text', x = 1.5, y = -log(0.045, 10), label = '~italic(p)== 0.05', parse = T, size=3.5) + 
  scale_colour_manual(values = c('black', '#003262')) + theme_minimal() + theme(text = element_text(size=10)) + theme(legend.position = "none") 
 
# quartz.save(file = '/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/volplotAsthmaInact.png', type = 'png', dpi = 300)

```

```{r, echo = F, out.width = '50%', echo = F}
knitr::include_graphics("/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/volplotAsthmaInact.png")
```

## Maternal atopy
### Unadjusted 
```{r, eval = F}
atopUnadj = dfRlmUnadj(miRNAcomb[,-c(1:3)], 'matop3', 130)

# Active during pregnancy vs. never
table(atopUnadj$p_preg <0.05 & abs(atopUnadj$B_preg) > .2)
# FALSE  TRUE 
  # 128     2 
  
table(atopUnadj$p_FDR_preg <0.2)
# FALSE 
# 130 

table(atopUnadj$p_FDR_preg <0.1)
# FALSE 
# 130 

table(atopUnadj$p_FDR_preg <0.05)
# FALSE 
# 130 

# Inactive vs. never
table(atopUnadj$p_inact < 0.05 & abs(atopUnadj$B_inact) > 0.2)
# FALSE  TRUE 
  # 111    19 
  
table(atopUnadj$p_FDR_inact <0.2)
# FALSE  TRUE 
#  122     8

table(atopUnadj$p_FDR_inact <0.1)
# FALSE  TRUE 
#  124     6 

table(atopUnadj$p_FDR_inact <0.05)
# FALSE  TRUE 
#  129     1

atopUnadj = merge(atopUnadj, miRBase[,c(5,3, 4)], by = 'miRNA')

# saving results
write.csv(atopUnadj, file = '/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/atopyUnadj.csv')
```

### Adjusted for sex, race, education, and week of breast milk collection
```{r, eval = F}
atopAdj = dfRlmAdjChage(miRNAcomb[,-c(1:3)], 'matop3', 130)

# Active during pregnancy vs. never
table(atopAdj$p_preg < 0.05 & abs(atopAdj$B_preg) > 0.2)
# FALSE  TRUE 
  # 129     1 

table(atopAdj$p_FDR_preg < 0.2)
# FALSE 
  # 130 

table(atopAdj$p_FDR_preg < 0.1)
# FALSE 
# 130 
 
table(atopAdj$p_FDR_preg < 0.05)
# FALSE 
# 130  

# Inactive vs. never
table(atopAdj$p_inact < 0.05 & abs(atopAdj$B_inact) > 0.2)
# FALSE  TRUE 
  # 123     7 

table(atopAdj$p_FDR_inact < 0.2)
# FALSE 
  # 130  
  
table(atopAdj$p_FDR_inact < 0.1)
# FALSE 
  # 130  
 
table(atopAdj$p_FDR_inact < 0.05)
# FALSE 
  # 130  

atopAdj = merge(atopAdj, miRBase[,c(5,3, 4)], by = 'miRNA')

# correcting microRNA names
atopAdj = merge(atopAdj, miRBase[,c(5,3, 4)], by = 'miRNA')

sigAtopAdj_preg = atopAdj[atopAdj$p_preg <0.05, ]
sigAtopAdj_preg = sigAtopAdj_preg[order(sigAtopAdj_preg$p_preg),]
sigAtopAdj_inact = atopAdj[atopAdj$p_inact <0.05, ]
sigAtopAdj_inact = sigAtopAdj_inact[order(sigAtopAdj_inact$p_inact),]

atopAdj$logp_preg = -log(atopAdj$p_preg, 10)
atopAdj$sig_preg[atopAdj$p_preg < 0.05] = 1
atopAdj$sig_preg[!(atopAdj$p_preg < 0.05)] = 0.4
atopAdj$logp_inact = -log(atopAdj$p_inact, 10)
atopAdj$sig_inact[atopAdj$p_inact < 0.05] = 1
atopAdj$sig_inact[!(atopAdj$p_inact < 0.05)] = 0.5

# saving results
write.csv(atopAdj, file = '/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/atopaAdj.csv')
```

#### Active during pregnancy
```{r, echo = F}
sigAtopAdj_preg %>% kable() %>% kable_styling(font_size = 12) 
```

```{r, eval = F}
# Raincloud plot
miRNA = rep(sigAtopAdj_preg$miRNA, times = nrow(miRNAcomb))
dCq = miRNAcomb[[sigAtopAdj_preg$miRNA]]
matop3 = miRNAcomb$matop3

dfBox = data.frame(miRNA, dCq, matop3)
dfBox_preg = dfBox[dfBox$matop3 != 1,]
dfBox_preg$matop3 = as.factor(as.character(dfBox_preg$matop3))

colnames(dfBox_preg) = c('miRNA', 'y_axis', 'x_axis')

df_1x1 <- data_1x1(array_1 = dfBox_preg$y_axis[dfBox_preg$x_axis == 0], 
	  array_2 = dfBox_preg$y_axis[dfBox_preg$x_axis == 2], jit_distance = .05, jit_seed = 321)
	df_1x1$jit = df_1x1$jit - 0.15
atopPlot = raincloud_1x1(data = df_1x1,  
      colors = (c('#F78104','#003262')),  
      fills = (c('#F78104','#003262')),  
      size = 0.5,  
      alpha = .6,  
      ort = 'v') + scale_x_continuous(breaks=c(1,2), labels=c("Never", "Active"), limits=c(0.5, 3)) +
  xlab("Maternal atopy status") + 
  ylab("hsa-miR-1290  -ΔCq") +
  theme_classic()

atopPlot

# quartz.save(file = '/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/rainPlotAtopyPreg.pdf', type = 'pdf', dpi = 300)
# quartz.save(file = '/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/rainPlotAtopyPreg.png', type = 'png', dpi = 300)

```

```{r, echo = F, out.width = '50%', echo = F}
knitr::include_graphics("/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/rainPlotAtopyPreg.png")
```

```{r, warning=FALSE,message=FALSE, eval = F}
# volcano plot
atopVol = ggplot(atopAdj, aes(x = B_preg, y = logp_preg)) + geom_point(size = 1.3, alpha = atopAdj$sig_preg, shape = 16) + geom_hline(yintercept = 0) + 
  geom_vline(xintercept = 0, size = 0.5) + geom_hline(yintercept=-log(0.05, 10), colour = '#b30000', linetype='dashed', size = 0.25) + 
  geom_vline(xintercept=-0.2, colour = '#b30000', linetype='dashed', size = 0.25) + geom_vline(xintercept=0.2, colour = '#b30000', linetype='dashed', size = 0.25) + 
  ylab(expression('-log'['10']~'('~italic('p')~')')) + xlab(expression(~italic("B")['Maternal atopy active during pregnancy vs. never'])) + annotate('text', x = 1.5, y = -log(0.045, 10), label = '~italic(p)== 0.05', parse = T, size=3.5) + 
  scale_colour_manual(values = c('black', '#003262')) + theme_minimal() + theme(text = element_text(size=10)) + theme(legend.position = "none") 

atopVol

# quartz.save(file = '/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/volplotAtopPreg.pdf', type = 'pdf', dpi = 300)
# quartz.save(file = '/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/volplotAtopPreg.png', type = 'png', dpi = 300)

# combining asthma and atopy volcano plots
asthVol = asthVol + annotate("text", x = -1.25, y = 1.85, label = "A", size = 7)
atopVol = atopVol + annotate("text", x = -1, y = 1.85, label = "B", size = 7)

grid.arrange(asthVol, atopVol, ncol = 2)

# quartz.save(file = '/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/volplotAsthmaAtopPreg.pdf', type = 'pdf', dpi = 300)
```

```{r, echo = F, out.width = '50%', echo = F}
knitr::include_graphics("/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/volplotAtopPreg.png")
```

#### Inactive
```{r, echo = F}
sigAtopAdj_inact %>% kable() %>% kable_styling(font_size = 12) 
```

```{r, warning=FALSE,message=FALSE, eval = F}
ggplot(atopAdj, aes(x = B_inact, y = logp_inact)) + geom_point(size = 1.3, alpha = atopAdj$sig_inact, shape = 16) + geom_hline(yintercept = 0) + 
  geom_vline(xintercept = 0, size = 0.5) + geom_hline(yintercept=-log(0.05, 10), colour = '#b30000', linetype='dashed', size = 0.25) + 
  geom_vline(xintercept=-0.2, colour = '#b30000', linetype='dashed', size = 0.25) + geom_vline(xintercept=0.2, colour = '#b30000', linetype='dashed', size = 0.25) + 
  ylab(expression('-log'['10']~'('~italic('p')~')')) + xlab(expression(~italic("B"))) + annotate('text', x = -1.5, y = -log(0.045, 10), label = '~italic(p)== 0.05', parse = T, size=3.5) + 
  scale_colour_manual(values = c('black', '#003262')) + theme_minimal() + theme(text = element_text(size=10)) + theme(legend.position = "none") 
 
 # quartz.save(file = '/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/volplotAtopInact.png', type = 'png', dpi = 300)
```

```{r, echo = F, out.width = '50%', echo = F}
knitr::include_graphics("/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/volplotAtopInact.png")
```

## Sensitivity analyses
### Asthma, excluding samples collected > 12 weeks postpartum
```{r, eval = F}
miRNAcomb_lt12 = miRNAcomb[miRNAcomb$wk_breastmilk <= 12,]

asthAdj_lt12 = dfRlmAdjChage(miRNAcomb_lt12[,-c(1:3)], 'masth3', 130)

# Active during pregnancy vs. never
table(asthAdj_lt12$p_preg < 0.05 & abs(asthAdj_lt12$B_preg) > 0.2)
# FALSE  TRUE 
  # 116    14 

table(asthAdj_lt12$p_FDR_preg < 0.2)
# FALSE 
  # 130 

table(asthAdj_lt12$p_FDR_preg < 0.1)
# FALSE 
# 130 
 
table(asthAdj_lt12$p_FDR_preg < 0.05)
# FALSE 
# 130 

# Inactive vs. never
table(asthAdj_lt12$p_inact < 0.05 & abs(asthAdj_lt12$B_inact) > 0.2)
# FALSE  TRUE 
  # 98   32 

table(asthAdj_lt12$p_FDR_inact < 0.2)
# FALSE  TRUE 
  # 98    32 
  
table(asthAdj_lt12$p_FDR_inact < 0.1)
# FALSE  TRUE 
  # 107    23
 
table(asthAdj_lt12$p_FDR_inact < 0.05)
# FALSE  TRUE 
  # 115    15 

# correcting microRNA names
asthAdj_lt12 = merge(asthAdj_lt12, miRBase[,c(5,3, 4)], by = 'miRNA')

sigAsthAdj_lt12_preg = asthAdj_lt12[asthAdj_lt12$p_preg <0.05, ]
sigAsthAdj_lt12_preg = sigAsthAdj_lt12_preg[order(sigAsthAdj_lt12_preg$p_preg),]
sigAsthAdj_lt12_inact = asthAdj_lt12[asthAdj_lt12$p_inact <0.05, ]
sigAsthAdj_lt12_inact = sigAsthAdj_lt12_inact[order(sigAsthAdj_lt12_inact$p_inact),]

# saving results
write.csv(asthAdj_lt12, file = '/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/asthmaAdj_lt12.csv')
```

### Atopy, excluding samples collected > 12 weeks postpartum
```{r, eval = F}
atopAdj_lt12 = dfRlmAdjChage(miRNAcomb_lt12[,-c(1:3)], 'matop3', 130)

# Active during pregnancy vs. never
table(atopAdj_lt12$p_preg < 0.05 & abs(atopAdj_lt12$B_preg) > 0.2)
# FALSE  TRUE 
  # 128     2 

table(atopAdj_lt12$p_FDR_preg < 0.2)
# FALSE 
  # 130 

table(atopAdj_lt12$p_FDR_preg < 0.1)
# FALSE 
# 130 
 
table(atopAdj_lt12$p_FDR_preg < 0.05)
# FALSE 
# 130 

# Inactive vs. never
table(atopAdj_lt12$p_inact < 0.05 & abs(atopAdj_lt12$B_inact) > 0.2)
# FALSE  TRUE 
  # 120	 10

table(atopAdj_lt12$p_FDR_inact < 0.2)
# FALSE  TRUE 
  # 127     3 
  
table(atopAdj_lt12$p_FDR_inact < 0.1)
# FALSE 
# 130 
 
table(atopAdj_lt12$p_FDR_inact < 0.05)
# FALSE 
# 130 

# correcting microRNA names
atopAdj_lt12 = merge(atopAdj_lt12, miRBase[,c(5,3, 4)], by = 'miRNA')

sigAtopAdj_lt12_preg = atopAdj_lt12[atopAdj_lt12$p_preg <0.05, ]
sigAtopAdj_lt12_preg = sigAtopAdj_lt12_preg[order(sigAtopAdj_lt12_preg$p_preg),]
sigAtopAdj_lt12_inact = atopAdj_lt12[atopAdj_lt12$p_inact <0.05, ]
sigAtopAdj_lt12_inact = sigAtopAdj_lt12_inact[order(sigAtopAdj_lt12_inact$p_inact),]

# saving results
write.csv(atopAdj_lt12, file = '/Users/annebozack/Documents/Lee/miRNA asthma/manuscript/clinical epigenetics submission/atopyAdj_lt12.csv')
```

